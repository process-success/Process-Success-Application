{"version":3,"sources":["ps.obj.js"],"names":["frappe","provide","ps","obj","init","get_function","update_function","doctype","items","id","args","hasUpdates","rerenderHook","get","callback","cmd","console","log","md5","JSON","stringify","get_from_local","online","updateQue","get_from_server","update","item","success","updateStorage","call","data","socket","emit","previousItems","storage","insert","i","length","name","push","store","updateItems","sucCallback","itemName","last","updateItemsCB","indexOf","splice","remove","updateItem","get_item","render","template","selector","bindings","$","render_template","appendTo","on","return_emit","rerender","derender","get_index_of_item","item_name","sort","priority","a","b","item_pushed","index","set_items","message","item_from_storage"],"mappings":"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","file":"ps.obj.js","sourcesContent":[" //--------------------------------------\n//       offline and live sync \n//            OBJECT TOOL \n//\n// Hooks up to a doctyp with a getfunction, \n// and update function\n// update function should take a json \n// representation of the returned get\n//______________________________________\n\n(function(){\n\tfrappe.provide(\"ps.obj\");\n\n\tps.obj.init=function(){\n\t\t//object tool.\n\t\t//in Template all html should be wrapped in element with id of item.name\n\t\t//run a init and save the returned object::  var myWorkorders=ps.obj.init();\n\t\t//run a get with args to populate the obj::  myWorkorders.get(args,callback);\n\t\t//  myWorkorders.workorders={**your workorders**}\n\t\t//  Do manipulations directly on this object  myWorkorders.workorders[0].start=new Date......\n\t\t//  pass obj from itself to itself is the best use case\n\t\tvar obj={};\n\t\tobj.get_function=\"\";\n\t\tobj.update_function=\"\";\n\t\tobj.doctype=\"\";\n\t\tobj.items=[];\n\t\tobj.id=\"\";\n\t\tobj.args={};\n\t\tobj.hasUpdates=0;\n\t\tobj.rerenderHook=function(){};\n\n\t\tobj.get=function(args,callback){\n\n\t\t\t//CHECK THE QUE FIRST\n\t\t\tif (typeof(args)==\"undefined\"){\n\t\t\t\targs={};\n\t\t\t}\n\t\t\tobj.args=args;\n\t\t\tobj.args.cmd=obj.get_function;\n\t\t\tconsole.log(obj.args);\n\t\t\tobj.id=md5(JSON.stringify(obj.args));\n\t\t\tget_from_local(obj.args);\n\t\t\tconsole.log(\"ONLINE\"+ps.online);\n\t\t\tif(ps.online){\n\t\t\t\tobj.updateQue(function(){get_from_server(obj.args,callback);});\n\t\t\t}\n\t\t\telse{\n\t\t\t\tget_from_local(obj.args,callback);\n\t\t\t}\n\t\t};\n\n\t\tobj.update=function(item,success){\n\t\t\tupdateStorage();\n\t\t\tvar args={};\n\t\t\targs.cmd=obj.update_function;\n\t\t\targs.item=item;\n\t\t\tif (ps.online){\n\t\t\t\tps.call(args,function(data){\n\t\t\t\t\tps.socket.socket.emit('update_item', {doctype:obj.doctype, item:item});\n\t\t\t\t\tif (typeof(success)!=\"undefined\"){\n\t\t\t\t\t\tsuccess();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\telse{\n\t\t\t\tvar previousItems=ps.storage.get(obj.id+\"que\");\n\t\t\t\tif (typeof(previousItems)!=\"undefined\"){\n\t\t\t\t\tvar insert=1;\n\t\t\t\t\tfor(var i = 0; i < previousItems.length; i++){\n\t\t\t\t\t\tif (previousItems[i]==item.name){\n\t\t\t\t\t\t\tinsert=0;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif(insert){\n\t\t\t\t\t\tpreviousItems.push(item.name);\n\t\t\t\t\t}\n\n\t\t\t\t}else{previousItems=[item.name];}\n\t\t\t\tps.storage.store(obj.id+\"que\",previousItems);\n\t\t\t\tobj.hasUpdates=1;\n\t\t\t}\n\t\t};\n\n\t\tobj.updateQue=function(callback){\n\t\t\tvar updateItems=ps.storage.get(obj.id+\"que\");\n\t\t\tfunction sucCallback(itemName,last){\n\t\t\t\treturn function(){\n\t\t\t\t\tvar updateItemsCB=ps.storage.get(obj.id+\"que\");\n\t\t\t\t\tvar i=updateItemsCB.indexOf(itemName);\n\t\t\t\t\tupdateItemsCB.splice(i,1);\n\t\t\t\t\tif(updateItemsCB.length===0){\n\t\t\t\t\t\tps.storage.remove(obj.id+\"que\");\n\t\t\t\t\t}else{\n\t\t\t\t\t\tps.storage.store(obj.id+\"que\",updateItemsCB);\n\t\t\t\t\t}\n\t\t\t\t\tif(last){callback();}\n\t\t\t\t};\n\t\t\t}\n\t\t\tif(ps.online){\n\t\t\t\tif(typeof(updateItems)!=\"undefined\"){\n\t\t\t\t\tfor(var i = 0; i < updateItems.length; i++){\n\t\t\t\t\t\tvar updateItem=updateItems[i];\n\t\t\t\t\t\tvar last=0;\n\t\t\t\t\t\tif (i==updateItems.length-1){last=1;}\n\t\t\t\t\t\tobj.update(obj.get_item(updateItem),sucCallback(updateItem,last));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse{callback();}\n\t\t\t}\n\t\t};\n\n\t\tobj.render=function(item,template,selector,bindings){\n\t\t\t$(frappe.render_template(template, item )).appendTo(selector);\n\t\t\tbindings(item.name);\n\t\t\tps.socket.socket.on('update_'+obj.doctype+'_'+item.name, return_emit(template,selector,bindings));\n\t\t};\n\t\tobj.rerender=function(item,template,selector,bindings){\n\t\t\t$(frappe.render_template(template, item )).appendTo(selector);\n\t\t\tbindings(item.name,obj);\n\t\t\tobj.rerenderHook();\n\t\t};\n\n\t\tobj.derender=function(item){\n\t\t\t$(\"#\" + item.name).remove();\n\t\t};\n\t\tobj.get_index_of_item= function(item_name){\n\t\t\tfor (var i = 0; i < obj.items.length; i++){\n\t\t\t\tif (item_name==obj.items[i].name){\n\t\t\t\t\treturn i;\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tobj.get_item = function(item_name){\n\t\t\tfor (var i = 0; i < obj.items.length; i++){\n\t\t\t\tif (item_name==obj.items[i].name){\n\t\t\t\t\treturn obj.items[i];\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\tobj.sort=function(){\n\t\t\tif(typeof(obj.items)!=\"undefined\" ){\n\t\t\t\tif(typeof(obj.items[0])!='undefined'){\n\t\t\t\t\tif (typeof(obj.items[0].priority)==\"undefined\"){\n\n\t\t\t\t\t}\n\t\t\t\t\telse{obj.items.sort(function(a, b){return a.priority-b.priority;});}\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\tfunction return_emit(template,selector,bindings){\n\t\t\treturn function(item_pushed) {\n\t\t\t\tconsole.log(\"Emit caught for \" +item_pushed.name);\n\t\t\t\tvar index=obj.get_index_of_item(item_pushed.name);\n\t\t\t\tobj.items[index]=item_pushed;\n\t\t\t\tobj.derender(item_pushed);\n\t\t\t\tobj.rerender(item_pushed,template,selector,bindings);\n\t\t\t};\n\t\t}\n\n\t\tfunction get_from_server(args,callback){\n\t\t\tconsole.log(obj.args);\n\t\t\tps.call(obj.args,function(data){\n\t\t\t\tset_items(obj.args,data.message);\n\t\t\t\tconsole.log(data.message);\n\t\t\t\tif(typeof(callback)!='undefined'){callback();}\n\t\t\t});\n\t\t}\n\n\t\tfunction set_items(args,items){\n\t\t\tobj.items=items;\n\t\t\tobj.sort();\n\t\t\tps.storage.store(args,items);\n\t\t}\n\t\tfunction updateStorage(){\n\t\t\tps.storage.store(obj.args,obj.items);\n\t\t}\n\n\t\tfunction get_from_local(args,callback){\n\t\t\tvar item_from_storage=ps.storage.get(args);\n\t\t\tif( typeof(item_from_storage)==\"undefined\"){\n\t\t\t\t//failed to get items\n\t\t\t\tconsole.log(\"Get local failed\");\n\t\t\t}\n\t\t\telse{set_items(args,item_from_storage);}\n\t\t\tif (typeof(callback)!=\"undefined\"){callback();}\n\t\t}\n\n\t\tps.socket.socket.on(\"reconnect\",function(){\n\t\t\t//obj.updateQue();\n\t\t});\n\n\t\treturn obj;\n\t};\n\n})();\n"]}