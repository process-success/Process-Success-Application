!function(){frappe.provide("ps"),frappe.provide("ps.frappe");ps.init_ui=function(){},ps.alert={},ps.alert.config={fadeIn:200,fadeOut:600,showFor:2e3},ps.successAlert=function(e){$(".success-text").html(" "+e);var t=$("#alerts #alert-success");t.fadeIn(ps.alert.config.fadeIn),setTimeout(function(){t.fadeOut(ps.alert.config.fadeOut)},ps.alert.config.showFor)},ps.failAlert=function(e){$(".fail-text").html(" "+e);var t=$("#alerts #alert-fail");t.fadeIn(ps.alert.config.fadeIn),setTimeout(function(){t.fadeOut(ps.alert.config.fadeOut)},ps.alert.config.showFor)},ps.offlineAlert=function(e){$(".fail-text").html(" You are now in offline mode."),$("#alerts #alert-offline").fadeIn(ps.alert.config.fadeIn)},ps.onlineAlert=function(e){$(".fail-text").html(" "+e),$("#alerts #alert-offline").fadeOut(ps.alert.config.fadeOut)},ps.set_handlers=function(e,t){var s=function(e,t){return function(s,i){s.responseJSON&&(i=s.responseJSON);var o=e;i._server_messages&&(o=($.map(JSON.parse(i._server_messages||"[]"),function(e){console.log(e);try{return JSON.parse(e).message}catch(t){return e}})||[]).join("<br>")||e),console.log(o),void 0!==t&&t()}};return{200:function(t){e(t)},401:s(__("error"),t),417:s(__("error"),t),404:s(__("error"),t),400:s(__("error"),t)}},ps.call=function(e,t,s){return frappe.call({type:"POST",args:e,freeze:!0,statusCode:ps.set_handlers(t,s)})},ps.escapeAttr=function(e){return e.replace(/(:|\.|\[|\]|,|=|@)/g,"\\$1")},ps.am_to_numeric=function(e){var t="",s=e.split(":"),i=s[1].split("A");if(1==i.length){var o=s[1].split("P");t=(parseInt(s[0])+12).toString()+":"+o[0]+":00"}else t=s[0]+":"+i[0]+":00";return t},ps.time_add_digits=function(e){var t=e.split(":");return 2==t.length?t[0]+":"+t[1]+":00":e},ps.time_add_front_zero=function(e){if(void 0!==e){for(var t=e.split(":"),s="",i=0;i<t.length;i++){var o=t[i];1==o.length&&(o="0"+o),s+=0==i?o:":"+o}return s}},ps.frappe.isready=0}(),frappe.ready(function(){ps.init_ui(),ps.frappe.isready=1}),ps.get_host=function(){var e=window.location.origin,t=e.split(":"),s=frappe.boot.socketio_port||"8000";return t.length>=2&&(e=t[1]),window.dev_server&&(e=e+":"+s),e},ps.hostReachable=function(){var e=new(window.ActiveXObject||XMLHttpRequest)("Microsoft.XMLHTTP");e.open("HEAD","//"+ps.get_host()+"/test.html",!1);try{return e.send(),e.status>=200&&(e.status<300||304===e.status)}catch(e){return!1}},ps.online=ps.hostReachable(),ps.socket={open_tasks:{},open_docs:[],init:function(){if(!ps.socket.socket){if("https:"==window.location.protocol?ps.socket.socket=io.connect(ps.socket.get_host(),{secure:!0}):"http:"==window.location.protocol&&(ps.socket.socket=io.connect(ps.socket.get_host())),!ps.socket.socket)return void console.log("Unable to connect to "+ps.socket.get_host());ps.socket.socket.on("msgprint",function(e){frappe.msgprint(e)}),ps.socket.socket.on("reconnect",function(e){ps.onlineAlert(),ps.online=!0,$(document).trigger("connected")}),ps.socket.socket.on("connect",function(e){ps.onlineAlert(),ps.online=!0,$(document).trigger("connected")}),ps.socket.socket.on("disconnect",function(e){ps.offlineAlert(),ps.online=!1})}},get_host:function(){var e=window.location.origin;if(window.dev_server){var t=e.split(":"),s=frappe.boot.socketio_port||"9000";t.length>2&&(e=t[0]+":"+t[1]),e=e+":"+s}return e},subscribe:function(e,t){},process_response:function(e,t){}},ps.socket.init(),frappe.ready(function(){}),frappe.provide("ps.storage"),ps.storage={ident:"pstimed",generateKey:function(e,t){var s=(new Date).getTime()+60*t*60*1e3;return this.ident+"?"+s+"?"+md5(JSON.stringify(e))},garbageCollect:function(){var e=[];if(localStorage.length>0)for(var t=0;t<localStorage.length;t++){var s=localStorage.key(t),i=s.split("?");if(3==i.length){var o=i[1];o<(new Date).getTime()&&e.push(s)}}if(e.length>0)for(var n=0;n<e.length;n++)localStorage.removeItem(e[n])},store:function(e,t,s){void 0===s&&(s=30);for(var i=this.generateKey(e,s),o=md5(JSON.stringify(e)),n=[],r=0;r<localStorage.length;r++){var a=localStorage.key(r),c=a.split("?");if(3==c.length){var p=c[2];c[0]==this.ident&&p==o&&n.push(a)}}if(n.length>0)for(var l=0;l<n.length;l++)localStorage.removeItem(n[l]);this.garbageCollect(),localStorage.setItem(i,JSON.stringify(t))},get:function(e){for(var t=md5(JSON.stringify(e)),s=0;s<localStorage.length;s++){var i=localStorage.key(s),o=i.split("?");if(3==o.length){var n=o[2];if(o[0]==this.ident&&n==t){var r=localStorage.getItem(i);return"undefined"==r?0:JSON.parse(r)}}}},remove:function(e){for(var t=md5(JSON.stringify(e)),s=0;s<localStorage.length;s++){var i=localStorage.key(s),o=i.split("?");if(3==o.length){var n=o[2];o[0]==this.ident&&n==t&&localStorage.removeItem(i)}}}},ps.performance={now:function(){return"undefined"!=typeof performance?performance.now():(console.log("performance unavalible"),1)}},ps.store={ident:"pstimed",lastCallSpeed:0,generateExpireTime:function(e){return(new Date).getTime()+60*e*60*1e3},store:function(e,t,s){var i=ps.performance.now();void 0===s&&(s=30);var o=(this.generateExpireTime(s),this.ident+"?"+e);if(Array.isArray(t))for(var n=0;n<t.length;n++){var r=t[n];this.storeSingle(o,r,s)}else this.storeSingle(o,t,s);var a=ps.performance.now();this.lastCallSpeed=a-i},storeSingle:function(e,t,s){void 0===s&&(s=30);var i=this.generateExpireTime(s),o=localStorage.getItem(e);if(null!==o){o=JSON.parse(o);for(var n=0;n<o.length;n++){var r=o[n];r.expire<(new Date).getTime()?(o.splice(n,1),n--):r.data.name==t.name&&(o.splice(n,1),n--)}}else o=[];var a={expire:i,data:t};o.push(a),localStorage.setItem(e,JSON.stringify(o))},get:function(e,t){var s=ps.performance.now(),i=this.ident+"?"+e,o=localStorage.getItem(i);if(null!==o){o=JSON.parse(o);for(var n=(new Date).getTime(),r=[],a=0;a<o.length;a++){var c=o[a];if(c.expire<n)o.splice(a,1),a--;else{var p=!0;for(var l in t)(t.hasOwnProperty(l)||c.data.hasOwnProperty(l))&&c.data[l]!=t[l]&&(p=!1);p&&r.push(c.data)}}var f=ps.performance.now();return this.lastCallSpeed=f-s,0===r.length?null:r}var f=ps.performance.now();return this.lastCallSpeed=f-s,null},remove:function(e,t){var s=ps.performance.now(),i=this.ident+"?"+e,o=localStorage.getItem(i);if(null!==o){o=JSON.parse(o);for(var n=(new Date).getTime(),r=0;r<o.length;r++){var a=o[r];(a.expire<n||a.data.name==t)&&(o.splice(r,1),r--)}localStorage.setItem(i,JSON.stringify(o));var c=ps.performance.now();return this.lastCallSpeed=c-s,null}var c=ps.performance.now();return this.lastCallSpeed=c-s,null},clear:function(e){var t=this.ident+"?"+e;localStorage.removeItem(t)}},function(){frappe.provide("ps.obj"),ps.obj.init=function(){function e(e,t,s){return function(i){var o=r.get_index_of_item(i.name);r.items[o]=i,r.rendermode&&(r.derender(i),r.rerender(i,e,t,s)),r.renderHook()}}function t(){return function(e){console.log("react emmit",e);var t=r.get_index_of_item(e.name);r.items[t]=e,r.renderHook()}}function s(e,t,s){ps.call(r.args,function(e){i(r.args,e.message),console.log("_________ps.obj From Server call_______________"),console.log(r.args,e.message),console.log("-----------------------------------------------"),void 0!==t&&t(e.message)},function(){console.log("call fail callback"),void 0!==t&&s()})}function i(e,t){r.items=t,r.sort(),ps.storage.store(e,t)}function o(){ps.storage.store(r.args,r.items)}function n(e,t){var s=ps.storage.get(r.args);void 0===s?console.log("Get local failed"):i(e,s),void 0!==t&&t()}var r={};return r.get_function="",r.update_function="",r.doctype="",r.items=[],r.id="",r.args={},r.hasUpdates=0,r.renderHook=function(){},r.rendermode=0,r.get=function(e,t,i){return void 0===e&&(e={}),r.args=e,r.args.cmd=r.get_function,r.id=md5(JSON.stringify(r.args)),n(r.args),console.log("ONLINE"+ps.online),ps.online?ps.frappe.isready?r.updateQue(function(){s(r.args,t,i)}):frappe.ready(function(){r.updateQue(function(){s(r.args,t,i)})}):n(r.args,t),r.items},r.update=function(e,t,s){o();var i={};i.cmd=r.update_function,i.item=e,ps.online?ps.call(i,function(i){if(void 0!==s&&1==s){r.get_index_of_item(e.name);console.log(i),ps.socket.socket.emit("update_item",{doctype:r.doctype,item:i.message})}else ps.socket.socket.emit("update_item",{doctype:r.doctype,item:e});void 0!==t&&t(i.message)}):r.addUpdateQue(e)},r.changed=function(e){ps.socket.socket.emit("update_item",{doctype:r.doctype,item:e})},r.addUpdateQue=function(e){var t=ps.storage.get(r.id+"que");if(void 0!==t){for(var s=1,i=0;i<t.length;i++)t[i]==e.name&&(s=0);s&&t.push(e.name)}else t=[e.name];ps.storage.store(r.id+"que",t),r.hasUpdates=1},r.updateQue=function(e){var t=ps.storage.get(r.id+"que");if(ps.online)if(void 0!==t)for(var s=0;s<t.length;s++){var i=t[s],o=0;s==t.length-1&&(o=1),r.update(r.get_item(i),function(t,s){return function(){var i=ps.storage.get(r.id+"que"),o=i.indexOf(t);i.splice(o,1),0===i.length?ps.storage.remove(r.id+"que"):ps.storage.store(r.id+"que",i),s&&e()}}(i,o))}else e()},r.reactSetup=function(e){if(r.renderHook=e,void 0===r.items);else for(var s=0;s<r.items.length;s++){var i=r.items[s];console.log(r.doctype+"_"+i.name),ps.socket.socket.on("update_"+r.doctype+"_"+i.name,t())}},r.render=function(t,s,i,o){r.rendermode=1,$(frappe.render_template(s,t)).appendTo(i),o(t.name),ps.socket.socket.on("update_"+r.doctype+"_"+t.name,e(s,i,o))},r.rerender=function(e,t,s,i){$(frappe.render_template(t,e)).appendTo(s),i(e.name,r)},r.derender=function(e){$("#"+e.name).remove()},r.get_index_of_item=function(e){for(var t=0;t<r.items.length;t++)if(e==r.items[t].name)return t},r.get_item=function(e){for(var t=0;t<r.items.length;t++)if(e==r.items[t].name)return r.items[t]},r.sort=function(){void 0!==r.items&&void 0!==r.items[0]&&(void 0===r.items[0].priority||r.items.sort(function(e,t){return e.priority-t.priority}))},ps.socket.socket.on("reconnect",function(){}),r}}(),$(document).bind("connected",function(){function e(e,t){return function(s){var i=s.message,o=e.type,n=e.doctype,r=e.args,a=e.key,c=JSON.parse(localStorage.getItem("actionQue"));"create"==o&&(i.tempid=t);for(var p=0;p<c.length;p++){a==c[p].key&&(c.splice(p,1),localStorage.setItem("actionQue",JSON.stringify(c)))}var l={};l.doctype=n;({create:function(){l.item=i,ps.socket.socket.emit("create_doc",l)},update:function(){l.item=i,ps.socket.socket.emit("update_doc",l)},remove:function(){l.name=r.name,ps.socket.socket.emit("remove_doc",l)}})[o]()}}var t=localStorage.getItem("actionQue");if(t=JSON.parse(t),ps.online&&null!==t&&void 0!==t)for(var s=0;s<t.length;s++){var i=t[s];if("create"==i.action){var o=i.args.item.tempid;delete i.args.item.tempid,ps.call(i.args,e(i,o))}else ps.call(i.args,e(i))}}),ps.apiTool=function(e,t,s){if(void 0===t.doctype)return console.log("ps.apiTool options must have a doctype defined"),null;this.onChange=s,this.doctype=t.doctype,this.default={get:"process_success.ps_core.api.get_all_full_doc",update:"process_success.ps_core.api.update_doc",create:"process_success.ps_core.api.create_doc",remove:"process_success.ps_core.api.remove_doc",call:ps.call,offline:!1},this.call=void 0===t.call?this.default.call:t.call,this.api={get:void 0===t.get?this.default.get:t.get,update:void 0===t.update?this.default.update:t.update,create:void 0===t.create?this.default.create:t.create,remove:void 0===t.remove?this.default.remove:t.remove},this.offlineEnabled=void 0===t.remove?this.default.offline:t.offline,this.items=[],this.filters=e,this.storage=ps.store,this.id="",this.init=function(){var t={};t.filters=this.filters,t.cmd=this.api.get,this.api.get==this.default.get&&(t.doctype=this.doctype),this.items=this.storage.get(this.doctype,e),ps.online?ps.frappe.isready?this.get_from_server(t):frappe.ready(function(){this.get_from_server(t)}):$(document).bind("connected",function(){this.get_from_server(t)}.bind(this))},this.update=function(e,t){this.filterItem(e);var s={};s.cmd=this.api.update,s.item=e,s.doctype=this.doctype,ps.online?ps.call(s,function(e){ps.socket.socket.emit("update_doc",{doctype:this.doctype,item:e.message}),this.filterItem(e.message),void 0!==t&&t(e.message)}.bind(this)):this.addToQue("update",s)},this.filterItem=function(e){var t=!0;for(var s in this.filters)(this.filters.hasOwnProperty(s)||e.hasOwnProperty(s))&&e[s]!=this.filters[s]&&(t=!1);if(null!=this.items){var i=this.get_index_of_item(e.name);if(t===!1){if(i!=-1)return this.items.splice(i,1),0}else if(i>=0)this.items[i]=e,this.setItems(this.items);else{if(e.hasOwnProperty("tempid")||e.hasOwnProperty("name")){var o=this.get_temp_id_index(e.tempid);this.storage.store(this.doctype,e),delete e.tempid,o!=-1?this.items[o]=e:this.items.push(e)}else this.items.push(e);this.setItems(this.items)}}else t&&(this.items=[],this.items.push(e),this.setItems(this.items));this.setItems(this.items)}.bind(this),this.create=function(e,t){e.tempid=1e16*Math.random(),this.filterItem(e);var s={};s.cmd=this.api.create,s.doctype=this.doctype,s.item=e,ps.online?ps.call(s,function(s){s.message.tempid=e.tempid,this.filterItem(s.message),void 0!==t&&t(s.message),ps.socket.socket.emit("create_doc",{doctype:this.doctype,item:s.message})}.bind(this)):this.addToQue("create",s)},this.remove=function(e,t){var s=this.get_index_of_item(e);s!=-1&&this.items.splice(s,1),this.storage.remove(this.doctype,e),this.setItems(this.items);var i={};i.cmd=this.api.remove,i.name=e,i.doctype=this.doctype,ps.online?ps.call(i,function(s){ps.socket.socket.emit("remove_doc",{doctype:this.doctype,name:e}),void 0!==t&&t(s.message)}.bind(this)):this.addToQue("remove",i),void 0!==this.onChange&&this.onChange()},ps.socket.socket.on("remove_"+this.doctype,function(e){var t=this.get_index_of_item(e);t!=-1&&this.items.splice(t,1),this.setItems(this.items)}.bind(this)),ps.socket.socket.on("update_"+this.doctype,function(e){this.filterItem(e)}.bind(this)),ps.socket.socket.on("create_"+this.doctype,function(e){this.filterItem(e)}.bind(this)),this.removeListeners=function(){ps.socket.socket.off("remove_"+this.doctype,function(e){}),ps.socket.socket.off("update_"+this.doctype,function(e){}),ps.socket.socket.off("create_"+this.doctype,function(e){})},this.addToQue=function(e,t){var s=JSON.parse(localStorage.getItem("actionQue")),i={};i.doctype=this.doctype,i.type=e,i.key=md5(JSON.stringify([i,s])),i.args=t,null===s&&(s=[]),s.push(i),localStorage.setItem("actionQue",JSON.stringify(s))},this.get_from_server=function(e){ps.call(e,function(e){if(void 0===e.message)return this.items=null,void 0!==this.onChange&&this.onChange(),null;this.setItems(e.message)}.bind(this),function(){console.log("call fail callback")})},this.setItems=function(e){console.log("LOG ITEMS!!!!!!!!",e),null!==e&&(this.items=e,this.storage.store(this.doctype,e),void 0!==this.onChange&&this.onChange())},this.get_item=function(e){for(var t=0;t<this.items.length;t++)if(e==this.items[t].name)return obj.items[t]},this.get_index_of_item=function(e){for(var t=0;t<this.items.length;t++)if(e==this.items[t].name)return t;return-1},this.get_temp_id_index=function(e){for(var t=0;t<this.items.length;t++)if(this.items[t].hasOwnProperty(e)&&e==this.items[t].tempid)return t;return-1},this.init()},frappe.provide("ps"),ps.initWorkorder=function(){var e=ps.obj.init();return e.doctype="work_orders",e.get_function="process_success.time_tracking.doctype.work_order.work_order.get_workorders",e.update_function="process_success.time_tracking.doctype.work_order.work_order.update_workorder",e},ps.initCurrentUser=function(){var e=ps.obj.init();return e.doctype="Employee",e.get_function="process_success.ps_core.api.get_current_users_info",e.update_function="",e},ps.initTimeSheets=function(){var e=ps.obj.init();return e.doctype="Time_Sheet",e.get_function="process_success.time_tracking.doctype.time_sheet.time_sheet.get_make_days_timesheets",e.update_function="process_success.time_tracking.doctype.time_sheet.time_sheet.update_timesheet",e.add_employee_to_sheet="",e},ps.initIssue=function(){var e=ps.obj.init();return e.doctype="Issue",e.get_function="process_success.core.doctype.issue.issue.get_issues",e.update_function="process_success.core.doctype.issue.issue.update_issue",e.create_function="process_success.core.doctype.issue.issue.create_issue",e.add_employee_to_sheet="",e},ps.initEmployeeList=function(){var e=ps.obj.init();return e.doctype="Employee",e.get_function="process_success.ps_core.api.get_all_employees",e.update_function="",e},ps.initGeneral=function(){},frappe.provide("ps.user"),ps.user.avatar=function(e,t,s){if(user_info={image:frappe.get_gravatar(e.name),fullname:e.full_name,abbr:frappe.get_abbr(e.full_name),color:frappe.get_palette(e.full_name)},s||(s=user_info.fullname),t||(t="avatar-small"),user_info.image){var i=window.cordova&&user_info.image.indexOf("http")===-1?frappe.base_url+user_info.image:user_info.image;return repl('<span class="avatar %(css_class)s" title="%(title)s"><span class="avatar-frame" style="background-image: url(%(image)s)"title="%(title)s"></span></span>',{image:i,title:s,abbr:user_info.abbr,css_class:t})}var o=user_info.abbr;return"avatar-small"!==t&&"avatar-xs"!=t||(o=o.substr(0,1)),repl('<span class="avatar %(css_class)s" title="%(title)s"><div class="standard-image" style="background-color: %(color)s;">%(abbr)s</div></span>',{title:s,abbr:o,css_class:t,color:user_info.color})};