!function(){frappe.provide("ps"),frappe.provide("ps.frappe");ps.init_ui=function(){},ps.alert={},ps.alert.config={fadeIn:200,fadeOut:600,showFor:2e3},ps.successAlert=function(e){$(".success-text").html(" "+e);var t=$("#alerts #alert-success");t.fadeIn(ps.alert.config.fadeIn),setTimeout(function(){t.fadeOut(ps.alert.config.fadeOut)},ps.alert.config.showFor)},ps.failAlert=function(e){$(".fail-text").html(" "+e);var t=$("#alerts #alert-fail");t.fadeIn(ps.alert.config.fadeIn),setTimeout(function(){t.fadeOut(ps.alert.config.fadeOut)},ps.alert.config.showFor)},ps.offlineAlert=function(e){$(".fail-text").html(" You are now in offline mode."),$("#alerts #alert-offline").fadeIn(ps.alert.config.fadeIn)},ps.onlineAlert=function(e){$(".fail-text").html(" "+e),$("#alerts #alert-offline").fadeOut(ps.alert.config.fadeOut)},ps.set_handlers=function(e,t){var s=function(e,t){return function(e,s){e.responseJSON&&(s=e.responseJSON);s._server_messages&&($.map(JSON.parse(s._server_messages||"[]"),function(e){try{return JSON.parse(e).message}catch(t){return e}})||[]).join("<br>"),void 0!==t&&t()}};return{200:function(t){e(t)},401:s(__("error"),t),417:s(__("error"),t),404:s(__("error"),t),400:s(__("error"),t)}},ps.call=function(e,t,s){return frappe.call({type:"POST",args:e,freeze:!0,statusCode:ps.set_handlers(t,s)})},ps.escapeAttr=function(e){return e.replace(/(:|\.|\[|\]|,|=|@)/g,"\\$1")},ps.am_to_numeric=function(e){var t="",s=e.split(":"),i=s[1].split("A");if(1==i.length){var o=s[1].split("P");t=(parseInt(s[0])+12).toString()+":"+o[0]+":00"}else t=s[0]+":"+i[0]+":00";return t},ps.time_add_digits=function(e){var t=e.split(":");return 2==t.length?t[0]+":"+t[1]+":00":e},ps.time_add_front_zero=function(e){if(void 0!==e){for(var t=e.split(":"),s="",i=0;i<t.length;i++){var o=t[i];1==o.length&&(o="0"+o),s+=0==i?o:":"+o}return s}},ps.frappe.isready=0,ps.clone=function(e){if(null==e||"object"!=typeof e)return e;var t=e.constructor();for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);return t}}(),frappe.ready(function(){ps.init_ui(),ps.frappe.isready=1}),ps.get_host=function(){var e=window.location.origin,t=e.split(":"),s=frappe.boot.socketio_port||"8000";return t.length>=2&&(e=t[1]),window.dev_server&&(e=e+":"+s),e},ps.hostReachable=function(){var e=new(window.ActiveXObject||XMLHttpRequest)("Microsoft.XMLHTTP");e.open("HEAD","//"+ps.get_host()+"/test.html",!1);try{return e.send(),e.status>=200&&(e.status<300||304===e.status)}catch(e){return!1}},ps.online=ps.hostReachable(),ps.socket={open_tasks:{},open_docs:[],init:function(){if(!ps.socket.socket){if("https:"==window.location.protocol?ps.socket.socket=io.connect(ps.socket.get_host(),{secure:!0}):"http:"==window.location.protocol&&(ps.socket.socket=io.connect(ps.socket.get_host())),!ps.socket.socket)return void console.log("Unable to connect to "+ps.socket.get_host());ps.socket.socket.on("msgprint",function(e){frappe.msgprint(e)}),ps.socket.socket.on("reconnect",function(e){ps.onlineAlert(),ps.online=!0,$(document).trigger("connected")}),ps.socket.socket.on("connect",function(e){ps.onlineAlert(),ps.online=!0,$(document).trigger("connected")}),ps.socket.socket.on("disconnect",function(e){ps.offlineAlert(),ps.online=!1})}},get_host:function(){var e=window.location.origin;if(window.dev_server){var t=e.split(":"),s=frappe.boot.socketio_port||"9000";t.length>2&&(e=t[0]+":"+t[1]),e=e+":"+s}return e},subscribe:function(e,t){},process_response:function(e,t){}},ps.socket.init(),frappe.ready(function(){}),frappe.provide("ps.storage"),ps.storage={ident:"pstimed",generateKey:function(e,t){var s=(new Date).getTime()+60*t*60*1e3;return this.ident+"?"+s+"?"+md5(JSON.stringify(e))},garbageCollect:function(){var e=[];if(localStorage.length>0)for(var t=0;t<localStorage.length;t++){var s=localStorage.key(t),i=s.split("?");if(3==i.length){var o=i[1];o<(new Date).getTime()&&e.push(s)}}if(e.length>0)for(var r=0;r<e.length;r++)localStorage.removeItem(e[r])},store:function(e,t,s){void 0===s&&(s=30);for(var i=this.generateKey(e,s),o=md5(JSON.stringify(e)),r=[],n=0;n<localStorage.length;n++){var a=localStorage.key(n),c=a.split("?");if(3==c.length){var p=c[2];c[0]==this.ident&&p==o&&r.push(a)}}if(r.length>0)for(var l=0;l<r.length;l++)localStorage.removeItem(r[l]);this.garbageCollect(),localStorage.setItem(i,JSON.stringify(t))},get:function(e){for(var t=md5(JSON.stringify(e)),s=0;s<localStorage.length;s++){var i=localStorage.key(s),o=i.split("?");if(3==o.length){var r=o[2];if(o[0]==this.ident&&r==t){var n=localStorage.getItem(i);return"undefined"==n?0:JSON.parse(n)}}}},remove:function(e){for(var t=md5(JSON.stringify(e)),s=0;s<localStorage.length;s++){var i=localStorage.key(s),o=i.split("?");if(3==o.length){var r=o[2];o[0]==this.ident&&r==t&&localStorage.removeItem(i)}}}},ps.performance={now:function(){return"undefined"!=typeof performance?performance.now():(console.log("performance unavalible"),1)}},ps.store={ident:"pstimed",lastCallSpeed:0,generateExpireTime:function(e){return(new Date).getTime()+60*e*60*1e3},store:function(e,t,s){var i=ps.performance.now();void 0===s&&(s=30);var o=(this.generateExpireTime(s),this.ident+"?"+e);if(Array.isArray(t))for(var r=0;r<t.length;r++){var n=t[r];this.storeSingle(o,n,s)}else this.storeSingle(o,t,s);var a=ps.performance.now();this.lastCallSpeed=a-i},storeSingle:function(e,t,s){void 0===s&&(s=30);var i=this.generateExpireTime(s),o=localStorage.getItem(e);if(null!==o){o=JSON.parse(o);for(var r=0;r<o.length;r++){var n=o[r];n.expire<(new Date).getTime()?(o.splice(r,1),r--):n.data.name==t.name&&(o.splice(r,1),r--)}}else o=[];var a={expire:i,data:t};o.push(a),localStorage.setItem(e,JSON.stringify(o))},get:function(e,t){var s=ps.performance.now(),i=this.ident+"?"+e,o=localStorage.getItem(i);if(null!==o){o=JSON.parse(o);for(var r=(new Date).getTime(),n=[],a=0;a<o.length;a++){var c=o[a];if(c.expire<r)o.splice(a,1),a--;else{var p=!0;for(var l in t)(t.hasOwnProperty(l)||c.data.hasOwnProperty(l))&&c.data[l]!=t[l]&&(p=!1);p&&n.push(c.data)}}var d=ps.performance.now();return this.lastCallSpeed=d-s,0===n.length?null:n}var d=ps.performance.now();return this.lastCallSpeed=d-s,null},remove:function(e,t){var s=ps.performance.now(),i=this.ident+"?"+e,o=localStorage.getItem(i);if(null!==o){o=JSON.parse(o);for(var r=(new Date).getTime(),n=0;n<o.length;n++){var a=o[n];(a.expire<r||a.data.name==t)&&(o.splice(n,1),n--)}localStorage.setItem(i,JSON.stringify(o));var c=ps.performance.now();return this.lastCallSpeed=c-s,null}var c=ps.performance.now();return this.lastCallSpeed=c-s,null},removeWithFilter:function(e,t,s){var i=ps.performance.now(),o=this.ident+"?"+e,r=localStorage.getItem(o);if(null!==r){r=JSON.parse(r);for(var n=(new Date).getTime(),a=0;a<r.length;a++){var c=r[a];(c.expire<n||c.data[t]==s)&&(r.splice(a,1),a--)}localStorage.setItem(o,JSON.stringify(r));var p=ps.performance.now();return this.lastCallSpeed=p-i,null}var p=ps.performance.now();return this.lastCallSpeed=p-i,null},clear:function(e){var t=this.ident+"?"+e;localStorage.removeItem(t)}},function(){frappe.provide("ps.obj"),ps.obj.init=function(){function e(e,t,s){return function(i){var o=n.get_index_of_item(i.name);n.items[o]=i,n.rendermode&&(n.derender(i),n.rerender(i,e,t,s)),n.renderHook()}}function t(){return function(e){console.log("react emmit",e);var t=n.get_index_of_item(e.name);n.items[t]=e,n.renderHook()}}function s(e,t,s){ps.call(n.args,function(e){i(n.args,e.message),void 0!==t&&t(e.message)},function(){console.log("call fail callback"),void 0!==s&&s()})}function i(e,t){n.items=t,n.sort(),ps.storage.store(e,t)}function o(){ps.storage.store(n.args,n.items)}function r(e,t){var s=ps.storage.get(n.args);void 0===s?console.log("Get local failed"):i(e,s),void 0!==t&&t()}var n={};return n.get_function="",n.update_function="",n.doctype="",n.items=[],n.id="",n.args={},n.hasUpdates=0,n.renderHook=function(){},n.rendermode=0,n.get=function(e,t,i){return void 0===e&&(e={}),n.args=e,n.args.cmd=n.get_function,n.id=md5(JSON.stringify(n.args)),r(n.args),console.log("ONLINE"+ps.online),ps.online?ps.frappe.isready?n.updateQue(function(){s(n.args,t,i)}):frappe.ready(function(){n.updateQue(function(){s(n.args,t,i)})}):r(n.args,t),n.items},n.update=function(e,t,s){o();var i={};i.cmd=n.update_function,i.item=e,ps.online?ps.call(i,function(i){if(void 0!==s&&1==s){n.get_index_of_item(e.name);ps.socket.socket.emit("update_item",{doctype:n.doctype,item:i.message})}else ps.socket.socket.emit("update_item",{doctype:n.doctype,item:e});void 0!==t&&t(i.message)}):n.addUpdateQue(e)},n.changed=function(e){ps.socket.socket.emit("update_item",{doctype:n.doctype,item:e})},n.addUpdateQue=function(e){var t=ps.storage.get(n.id+"que");if(void 0!==t){for(var s=1,i=0;i<t.length;i++)t[i]==e.name&&(s=0);s&&t.push(e.name)}else t=[e.name];ps.storage.store(n.id+"que",t),n.hasUpdates=1},n.updateQue=function(e){var t=ps.storage.get(n.id+"que");if(ps.online)if(void 0!==t)for(var s=0;s<t.length;s++){var i=t[s],o=0;s==t.length-1&&(o=1),n.update(n.get_item(i),function(t,s){return function(){var i=ps.storage.get(n.id+"que"),o=i.indexOf(t);i.splice(o,1),0===i.length?ps.storage.remove(n.id+"que"):ps.storage.store(n.id+"que",i),s&&e()}}(i,o))}else e()},n.reactSetup=function(e){if(n.renderHook=e,void 0===n.items);else for(var s=0;s<n.items.length;s++){var i=n.items[s];ps.socket.socket.on("update_"+n.doctype+"_"+i.name,t())}},n.render=function(t,s,i,o){n.rendermode=1,$(frappe.render_template(s,t)).appendTo(i),o(t.name),ps.socket.socket.on("update_"+n.doctype+"_"+t.name,e(s,i,o))},n.rerender=function(e,t,s,i){$(frappe.render_template(t,e)).appendTo(s),i(e.name,n)},n.derender=function(e){$("#"+e.name).remove()},n.get_index_of_item=function(e){for(var t=0;t<n.items.length;t++)if(e==n.items[t].name)return t},n.get_item=function(e){for(var t=0;t<n.items.length;t++)if(e==n.items[t].name)return n.items[t]},n.sort=function(){void 0!==n.items&&void 0!==n.items[0]&&(void 0===n.items[0].priority||n.items.sort(function(e,t){return e.priority-t.priority}))},ps.socket.socket.on("reconnect",function(){}),n}}(),$(document).bind("connected",function(){function e(e,t){return function(s){var i=s.message,o=e.type,r=e.doctype,n=e.args,a=e.key,c=JSON.parse(localStorage.getItem("actionQue"));"create"==o&&(i.tempid=t);for(var p=0;p<c.length;p++){a==c[p].key&&(c.splice(p,1),localStorage.setItem("actionQue",JSON.stringify(c)))}var l={};l.doctype=r;({create:function(){l.item=i,ps.socket.socket.emit("create_doc",l)},update:function(){l.item=i,ps.socket.socket.emit("update_doc",l)},remove:function(){l.name=n.name,ps.socket.socket.emit("remove_doc",l)}})[o]()}}var t=localStorage.getItem("actionQue");if(t=JSON.parse(t),ps.online&&null!==t&&void 0!==t)for(var s=0;s<t.length;s++){var i=t[s];if("create"==i.action){var o=i.args.item.tempid;delete i.args.item.tempid,ps.call(i.args,e(i,o))}else ps.call(i.args,e(i))}}),ps.apiTool=function(e,t,s){if(void 0===t.doctype)return console.log("ps.apiTool options must have a doctype defined"),null;this.onChange=s,this.multiDoc=!1,"object"==typeof t.doctype&&(this.multiDoc=!0),this.doctype=t.doctype,this.default={get:"process_success.ps_core.api.get_all_full_doc",update:"process_success.ps_core.api.update_doc",create:"process_success.ps_core.api.create_doc",remove:"process_success.ps_core.api.remove_doc",call:ps.call,offline:!1},this.call=void 0===t.call?this.default.call:t.call,this.api={get:void 0===t.get?this.default.get:t.get,update:void 0===t.update?this.default.update:t.update,create:void 0===t.create?this.default.create:t.create,remove:void 0===t.remove?this.default.remove:t.remove},this.offlineEnabled=void 0===t.remove?this.default.offline:t.offline,this.items=[],this.filters=e,this.storage=ps.store,this.id="",this.init=function(){var t={};if(t.filters=this.filters,t.cmd=this.api.get,this.api.get==this.default.get&&(t.doctype=this.doctype),this.multiDoc)for(var s=0;s<this.doctype.length;s++)this.items.push.apply(this.items,this.storage.get(this.doctype[s],e));else this.items=this.storage.get(this.doctype,e);ps.online?ps.frappe.isready?this.get_from_server(t):frappe.ready(function(){this.get_from_server(t)}):$(document).bind("connected",function(){this.get_from_server(t)}.bind(this))},this.update=function(e,t){this.filterItem(e);var s={};s.cmd=this.api.update,s.item=e,console.log(s.doctype),s.doctype=e.doctype,ps.online?ps.call(s,function(s){ps.socket.socket.emit("update_doc",{doctype:e.doctype,item:s.message}),this.filterItem(s.message),void 0!==t&&t(s.message)}.bind(this)):this.addToQue("update",s)},this.filterItem=function(e){var t=!0;for(var s in this.filters)(this.filters.hasOwnProperty(s)||e.hasOwnProperty(s))&&e[s]!=this.filters[s]&&(t=!1);if(null!=this.items){var i=this.get_index_of_item(e.name);if(t===!1){if(i!=-1)return this.items.splice(i,1),0}else if(i>=0)this.items[i]=e,this.setItems(this.items);else{if(e.hasOwnProperty("tempid")&&e.hasOwnProperty("name")){var o=this.get_temp_id_index(e.tempid);this.storage.removeWithFilter(this.doctype,"tempid",e.tempid),this.storage.store(this.doctype,e),delete e.tempid,o!=-1?this.items[o]=e:this.items.push(e)}else this.items.push(e);this.setItems(this.items)}}else t&&(this.items=[],this.items.push(e),this.setItems(this.items));this.setItems(this.items)}.bind(this),this.create=function(e,t){e.tempid=1e16*Math.random();var s={};s.cmd=this.api.create,e.doctype?s.doctype=e.doctype:s.doctype=this.doctype,s.item=e,ps.online?ps.call(s,function(i){i.message.tempid=e.tempid,this.filterItem(i.message),void 0!==t&&t(i.message),ps.socket.socket.emit("create_doc",{doctype:s.doctype,item:i.message})}.bind(this)):this.addToQue("create",s)},this.remove=function(e,t,s){var i=this.get_index_of_item(e);i!=-1&&this.items.splice(i,1),this.storage.remove(this.doctype,e),this.setItems(this.items);var o={};o.cmd=this.api.remove,o.name=e,o.doctype=s?s:this.doctype,ps.online?ps.call(o,function(s){ps.socket.socket.emit("remove_doc",{doctype:this.doctype,name:e}),void 0!==t&&t(s.message)}.bind(this)):this.addToQue("remove",o),void 0!==this.onChange&&this.onChange()},this.delete=function(e,t){var s=e.name,i=this.get_index_of_item(s);i!=-1&&this.items.splice(i,1),this.storage.remove(e.doctype,s),this.setItems(this.items);var o={};o.cmd=this.api.remove,o.name=s,o.doctype=e.doctype,ps.online?ps.call(o,function(e){ps.socket.socket.emit("remove_doc",{doctype:this.doctype,name:s}),void 0!==t&&t(e.message)}.bind(this)):this.addToQue("remove",o),void 0!==this.onChange&&this.onChange()},ps.socket.socket.on("remove_"+this.doctype,function(e){var t=this.get_index_of_item(e);t!=-1&&this.items.splice(t,1),this.setItems(this.items)}.bind(this)),ps.socket.socket.on("update_"+this.doctype,function(e){this.filterItem(e)}.bind(this)),ps.socket.socket.on("create_"+this.doctype,function(e){this.filterItem(e)}.bind(this)),this.removeListeners=function(){ps.socket.socket.off("remove_"+this.doctype,function(e){}),ps.socket.socket.off("update_"+this.doctype,function(e){}),ps.socket.socket.off("create_"+this.doctype,function(e){})},this.addToQue=function(e,t){var s=JSON.parse(localStorage.getItem("actionQue")),i={};i.doctype=this.doctype,i.type=e,i.key=md5(JSON.stringify([i,s])),i.args=t,null===s&&(s=[]),s.push(i),localStorage.setItem("actionQue",JSON.stringify(s))},this.get_from_server=function(e){ps.call(e,function(e){if(void 0===e.message)return this.items=null,void 0!==this.onChange&&this.onChange(),null;this.setItems(e.message)}.bind(this),function(){console.log("call fail callback")})},this.setItems=function(e){null!==e&&(this.items=e,this.storage.store(this.doctype,e),void 0!==this.onChange&&this.onChange())},this.get_item=function(e){for(var t=0;t<this.items.length;t++)if(e==this.items[t].name)return obj.items[t]},this.get_index_of_item=function(e){for(var t=0;t<this.items.length;t++)if(e==this.items[t].name)return t;return-1},this.get_temp_id_index=function(e){for(var t=0;t<this.items.length;t++)if(this.items[t].hasOwnProperty(e)&&e==this.items[t].tempid)return t;return-1},this.init()},frappe.provide("ps"),ps.initWorkorder=function(){var e=ps.obj.init();return e.doctype="work_orders",e.get_function="process_success.time_tracking.doctype.work_order.work_order.get_workorders",e.update_function="process_success.time_tracking.doctype.work_order.work_order.update_workorder",e},ps.apiSetup={},ps.apiSetup.workOrders={doctype:"work_order",update:"process_success.time_tracking.doctype.work_order.work_order.update_workorder"},ps.apiSetup.vineyardTasks={doctype:["Spraying"]},ps.initCurrentUser=function(){var e=ps.obj.init();return e.doctype="Employee",e.get_function="process_success.ps_core.api.get_current_users_info",e.update_function="",e},ps.initTimeSheets=function(){var e=ps.obj.init();return e.doctype="Time_Sheet",e.get_function="process_success.time_tracking.doctype.time_sheet.time_sheet.get_make_days_timesheets",e.update_function="process_success.time_tracking.doctype.time_sheet.time_sheet.update_timesheet",e.add_employee_to_sheet="",e},ps.initIssue=function(){var e=ps.obj.init();return e.doctype="Issue",e.get_function="process_success.core.doctype.issue.issue.get_issues",e.update_function="process_success.core.doctype.issue.issue.update_issue",e.create_function="process_success.core.doctype.issue.issue.create_issue",e.add_employee_to_sheet="",e},ps.initEmployeeList=function(){var e=ps.obj.init();return e.doctype="Employee",e.get_function="process_success.ps_core.api.get_all_employees",e.update_function="",e},ps.initGeneral=function(){},frappe.provide("ps.user"),ps.user.avatar=function(e,t,s){if(user_info={image:frappe.get_gravatar(e.name),fullname:e.full_name,abbr:frappe.get_abbr(e.full_name),color:frappe.get_palette(e.full_name)},s||(s=user_info.fullname),t||(t="avatar-small"),user_info.image){var i=window.cordova&&user_info.image.indexOf("http")===-1?frappe.base_url+user_info.image:user_info.image;return repl('<span class="avatar %(css_class)s" title="%(title)s"><span class="avatar-frame" style="background-image: url(%(image)s)"title="%(title)s"></span></span>',{image:i,title:s,abbr:user_info.abbr,css_class:t})}var o=user_info.abbr;return"avatar-small"!==t&&"avatar-xs"!=t||(o=o.substr(0,1)),repl('<span class="avatar %(css_class)s" title="%(title)s"><div class="standard-image" style="background-color: %(color)s;">%(abbr)s</div></span>',{title:s,abbr:o,css_class:t,color:user_info.color})};